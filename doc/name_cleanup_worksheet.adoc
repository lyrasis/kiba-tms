:toc:
:toc-placement!:
:toclevels: 4

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

= Name cleanup worksheet for TMS-to-CS migration

toc::[]


== Important things re: working with the worksheet
* It is fine to sort/filter the worksheet however you want in order to review and edit your data.
* Feel free to change the order of the columns to support your work. 
* **Do not edit any values in grey-ed out columns**. If you change data in the grey-ed out  columns, we may not be able to merge your work back into the migration.
* **Do not change column names** or we may not be able to merge your work back into the migration.
* **Do not delete any rows**. Adding rows is ok when needed, as explained in examples below.

=== General way this spreadsheet works in the migration
You make changes and additions in the spreadsheet as per the instructions below. You return the completed worksheet to LYRASIS migration staff.

The spreadsheet then becomes another data source in the migration. The `fingerprint` column allows us to match each row up to the original TMS data it came from. We override the original data in each row with whatever changes you made. If you tell us to ignore a row, the migration will proceed as though that row didn't exist. Essentially, we use this to create a "just in the migration process" version of your data.

At the beginning of the final phase of the migration, when you send us the final data to migrate into your production CS, we will run the final data through this process, generate the "just in the migration process" version of your data, and re-check it for new duplicates or any other issues. At this point, you may need to complete a smaller version of this spreadsheet to handle any issues introduced by new data in the system.

== Explanation of selected worksheet columns
`termsource`:: Where the name came from---TMS table or a data extraction method
`normalized_form`:: The value of `preferred_name_form` column, normalized for CS import. This value was derived by code outside Excel and will NOT change as you add/change values.
`approx_normalized`:: Dynamic approximation of normalized form to help you as you add or change data in Excel. Duplicate values will be highlighted pink. Excel can't handle the full normalization logic, so this isn't 100% accurate.
`duplicate`:: Whether name is a duplicate. This is based on `normalized_form`, so you will see some non-exact matches flagged as duplicates. This is because, due to the under-the-hood way CS created behind-the-scenes unique IDs for authority terms, these would kbe seen by the system as the same. See <<on-duplicates>> and <<prepare-for-reviewing-duplicates>>.
`inconsistent_org_names`:: Flags organization names with unexpected name variations for review and possible cleanup
`missing_last_name`:: Flags person names lacking a `lastname` value for review and possible cleanup. (We only check for last name because it is important for sorting/reporting by surname)
`migration_action`:: For you to fill in to indicate what to do with a name in the migration. More details below.
`preferred_name_form`:: For names with `termsource`=`TMS Constituents`, if you chose direct form of name as your preferred name form, this column has the values from the TMS `displayname` field. If you chose inverted form of name as your preferred name form, this column has the values from the TMS `alphasort` field. For additional names derived from Constituents table by migration logic, we try to follow your preferred name form here, using available Constituent data. For names from other sources, this contains the name as it exists in that source.footnote:[These other tables do not include the level of name detail as Constituents table, so we just take the value as entered.]
`variant_name_form`:: For names with `termsource`=`TMS Constituents`, if you chose direct form of name as your preferred name form, this column has the values from the TMS `alphasort` field. If you chose inverted form of name as your preferred name form, this column has the values from the TMS `displayname` field. For additional names derived from Constituents table by migration logic, we try to use available Constituent data to construct the proper variant name. For names from other sources, we can't populate this automatically.
`alt_names`:: Names merged in from TMS `ConAltNames` table for review
`contact_person`:: See <<on-modeling-relationships-between-person-and-organization>>
`contact_role`:: The TMS `Constituents.position` field
`fingerprint`:: A representation of the original data for this name. This is the most important value for merging your work back into the migration. **It is crucial that you do not edit this column**
`matchpref`:: Used to power the conditional formatting that highlights `contact_person` values if they do not exist as Person names. **Do not edit.**

Other fields not named above are from the TMS `Constituents` table.

== Background, and important things about authorities in CS that affect this work

* All names in CS need to be categorized as `Person` or `Organization`. Name rows without a value in `constituenttype` will not be migrated

=== On duplicates

* CS will let you have exact duplicate name records within a given authority, but for the purposes of the migration we have to avoid that. For your general data integrity and ability to batch update your data with the CSV Import Tool in the future, you also want to avoid this.

[NOTE]
====
These would not be considered duplicates in CS, since they are in two different authorities:.footnote:[What you want to avoid is having the exact same name more than once in the same authority, which is confusing and ambiguous in terms of making sure you are using the correct name in other records, and in batch-updating names via the CSV Importer]

- Hugo Boss (with `constituenttype`=`Organization`)
- Hugo Boss (with `constituenttype`= `Person`)

They are flagged here as duplicates for review in case they are not really both an organization and a person.
====

=== On modeling relationships between Person and Organization
* A CS Organization authority record has a dedicated/linked field (Contact Person, with associated Contact Role) in which to record an associated Person, but the details of the person name have to be recorded in the Person name record
** TMS lets you record details of individual/person names (first name, middle name, title, etc.) in a Consituent coded as an Institution or other type mapped to CS Organization.

* A CS Person authority record does not have a dedicated/linked field in which to record an associated Organization
** If a person has been included as a contact in an Organization record, you can see that from the Person record.
** TMS allows you to record an institution in a Constituent coded as an Individual

Because of the above differences, we need to extract some extra rows of data from some Constituent records for your review. These rows can be identified by the `termsource` column value as described below.

* `termsource` = `TMS Constituents.orgs_with_person_names`
** Original constituent record is coded as not an Individual, but includes person name details
** A row has been added for the Person name recorded as part of the constituent record.

* `termsource` = `TMS Constituents.org_with_contact_person`
** Original constituent record is coded as an Individual, but includes an institution name
** A row has been added for the Organization name recorded as part of the constituent record.
** The preferred form of the person name is recorded as the contact person for the derived Organization

NOTE: Breaking this data out usually introduces some rows marked as duplicates, but also adds names that wouldn't otherwise migrate

== To-do overview

More details on each step are given below. Examples are included!

1. Ensure all names have the appropriate `use_type` value: "Person" or "Organization"
2. Check and resolve names where `duplicate` value = `y`
3. Check and resolve names where `inconsistent_org_names` value = `y`
4. Check and add name details (first, middle, last names, etc.) where `missing_last_name` = `y` footnote:[This checks only for missing last name, as that's the most important element for sorting/reporting properly. You may also want to do things like: filter to `use_type` = `Person` and filter to blank `firstname` values.]
5. Look for and merge near-duplicates and variants
6. Ensure all `contact_person` values exist as Person names

== Step details
=== Ensure all names have the appropriate `use_type` value: "Person" or "Organization"

This includes providing missing values (Strategy 1) and verifying/correcting existing values (remaining strategies).

==== Strategy 1: Filter to `use_type` empty
Provide the appropriate value for any rows

==== Strategy 2: Filter to `missing_last_name` = `y`
Should some of these be coded as Organizations instead of people? See <<switch-a-person-to-an-organization>>.

== How to

NOTE: In the examples below, columns are omitted if they aren't relevant to the change you want to make.

=== Filter column to values with warning highlighting
* Click the down-pointing triangle on the right of the heading
* Filter >> By color >> Cell color >> Rose

This will show you only rows with warning highlighting in that column.

Instead of filtering, you can do Sort >> By color >> Cell color >> Rose to see the highlighted rows at the top

=== Handle duplicates when one record has full data and the other is just a name value

.Example data
[source]
----
| termsource       | migration_action | constituenttype | preferred_name_form | variant_name_form |
|------------------+------------------+-----------------+---------------------+-------------------|
| TMS Constituents |                  | Person          | Ann Smith           | Smith, Ann        |
| TMS ObjLocations |                  | Person          | Ann Smith           |                   |
----

Assume other fields in the row from TMS Constituents are also filled in (nationality, bio, etc.).

To fix:

.Edited data will ignore row from TMS ObjLocations in migration
[source]
----
| termsource       | migration_action | constituenttype | preferred_name_form | variant_name_form |
|------------------+------------------+-----------------+---------------------+-------------------|
| TMS Constituents |                  | Person          | Ann Smith           | Smith, Ann        |
| TMS ObjLocations | ignore           | Person          | Ann Smith           |                   |
----

This should no longer be highlighted as a duplicate in `approx_normalized`.

Person authority will be created using TMS Constituents row. Any uses of this name in TMS ObjLocations will be linked to the authority as expected.

=== Organization and Person have same name values

.Original
[source]
----
| constituenttype | preferred_name_form | variant_name_form | institution | contact_person | firstname | lastname |
|-----------------+---------------------+-------------------+-------------+----------------+-----------+----------|
| Organization    | Fanny Mae           | Mae, Fanny        |             | Fanny Mae      | Fanny     | Mae      |
| Person          | Fanny Mae           | Mae, Fanny        | Fanny Mae   |                | Fanny     | Mae      |
----

* Companies do not have inverted form of name (Mae, Fanny), nor first names and last names, so clear the values for `variant_name_form`, `firstname`, and `lastname`.
* Person names do not record links to institutions. Clear the `institution` value. A link between this organization and person will be made based on the `contact_person` value in the organization name. 

.Fixed
[source]
----
| constituenttype | preferred_name_form | variant_name_form | institution | contact_person | firstname | lastname |
|-----------------+---------------------+-------------------+-------------+----------------+-----------+----------|
| Organization    | Fanny Mae           |                   |             | Fanny Mae      |           |          |
| Person          | Fanny Mae           | Mae, Fanny        |             |                | Fanny     | Mae      |
----

=== Prepare for reviewing duplicates
* Sort by `normalized_form`
* Filter to `duplicate` = `y`

=== Switch a Person to an Organization

**First** make sure there aren't both a Person and Organization row for the same name. Handling that situation is different. See <<organization-and-person-have-same-name-values>>.

* Change the `constituenttype` value to `Organization`
* **Do not** fill in `institution` value

.Example "Person" data that should be an Organization
[source]
----
| constituenttype | preferred_name_form | variant_name_form | alt_names | institution | firstname | middlename | lastname |
|-----------------+---------------------+-------------------+-----------+-------------+-----------+------------+----------|
| Person          | W.W. Norton         |                   |           |             |           |            |          |
----

.Changed to migrate as an Organization
[source]
----
| constituenttype | preferred_name_form | variant_name_form | alt_names | institution | firstname | middlename | lastname |
|-----------------+---------------------+-------------------+-----------+-------------+-----------+------------+----------|
| Organization    | W.W. Norton         |                   |           |             |           |            |          |
----

=== Switch an Organization to a Person

**First** make sure there aren't both a Person and Organization row for the same name. Handling that situation is different. See <<organization-and-person-have-same-name-values>>.

* Change the `constituenttype` value to `Person`
* Fill in the `variant_name_form` with relevant form of Person name
* Fill in the name details (title, first, middle, last, suffix, etc.)

.Example "Organization" data that should be a Person
[source]
----
| constituenttype | preferred_name_form | variant_name_form | alt_names | institution | firstname | middlename | lastname |
|-----------------+---------------------+-------------------+-----------+-------------+-----------+------------+----------|
| Organization    | James Comp          |                   |           |             |           |            |          |
----

.Changed to migrate as a Person
[source]
----
| constituenttype | preferred_name_form | variant_name_form | alt_names | institution | firstname | middlename | lastname |
|-----------------+---------------------+-------------------+-----------+-------------+-----------+------------+----------|
| Person          | James Comp          | Comp, James       |           |             | James     |            | Comp     |
----

